# 输入与输出

本章节介绍神经网络的输入输出处理，神经网络内部结构见[Model](model.md)

## 原数据的基本处理

原数据包括样本图库、鞋印图库、待判定范围文件，对样本图库与鞋印图库进行同样的处理，得到符合神经网络输入要求的“缩略图”，将该图片输入神经网络，获得一个嵌入，至于待判定范围文件的处理就很简单了，不赘述

::: tip

-  训练并没有用到待判定文件，以免网络对原有检索算法过拟合
-  训练仅使用了二值图，测试相应地也应该只使用二值图

:::

## 图片的处理

根据对样本图片大小的统计，得到平均高宽比 `2.79`，使用比较合适的拟合比例 `129:49` (这两个值在 `pool_size=3, strides=2` 能够降低损失的边缘像素点)，故将图片 `resize` 到 `(129, 49)`

为了使神经网络鲁棒性更好，需要对数据进行一定的扩增，参考论文 $\href{#references}{^{[1]}}$ 中提到的数据扩增方式对数据进行扩增，暂实现以下扩增方式

-  镜像扩增（水平镜像）
-  旋转扩增（顺时针 5、逆时针 5）
-  平移扩增（上下左右 30 像素）
-  椒盐噪声扩增（使用 0.01 密度的椒盐噪声）
-  随机遮挡扩增（40 个 30 \* 30 的块遮挡）
-  区域遮挡扩增（下半部一个水平遮挡条）
-  弹性形变扩增（随机弹性形变，暂时耗时非常大，待优化）
-  中值滤波扩增（降噪措施，暂未使用）
-  高斯滤波扩增（降噪措施，暂未使用）
-  双边滤波扩增（降噪措施，用于测试）
-  均值滤波扩增（降噪措施，暂未使用）

当前训练与测试分别使用了以下的扩增方式

-  训练 （共 22 张）
   -  镜像
   -  对原图与镜像分别作如下扩增
      -  旋转 \* 2
      -  平移 \* 4
      -  椒盐噪声 \* 1
      -  随机遮挡 \* 1
      -  区域遮挡 \* 1
      -  弹性形变 \* 1
-  测试 （共 3 张）
   -  镜像
   -  双边滤波

::: tip

-  训练使用加噪声是为了使神经网络鲁棒性更好，测试时降噪声是为了提高准确率
-  测试时，样本图库图片并不进行扩增
-  测试时会从 3 张图片的嵌入中挑选出与待判定图片嵌入最小的一个作为该图片的嵌入
-  由于每个三元组图片是大量重复使用的，为了充分利用内存，所有数据在 feed 之前均以 index 存储，处理完成的图片仅仅存储一份，不会有同一张图片存储两次的情况

:::

## 测试的输出

图片通过网络获得一个嵌入向量，首先求得样本图库的嵌入（防止重复计算），之后将待判定图片嵌入也计算出来，计算 50 个待判定范围与待判定图片嵌入之差，也即嵌入之间的“距离”，其中距离最小的那个就是神经网络所“认为”的判定结果

根据题目要求，要在 `result.txt` 中输出待判定范围图片的评分，评分越高应当与待判定图片越相似，故使用**距离的倒数**作为评分

::: tip

-  为了防止发生 OOM ，嵌入的计算也是分批的，最后整合到一起，batch 大小由 $emb_step$ 调节
-  由于样本图库固定，一旦网络训练好，直接 cache 就行，以降低生产环境时识别时间，当然，本程序也实现了该功能，在每次求得样本图库嵌入后会自动将该嵌入 cache 起来，之后测试只需要使用参数 `--use-cache` 就可以直接读取已经编码完成的样本图库嵌入
-  由于在神经网络输出之前对嵌入进行了 $L^2$ 归一化，所以最终的嵌入向量的空间表征应该是超球面上的一点
-  嵌入向量在空间表征的两点间距离也即两向量的 $L^2$ 范数
-  如果仅仅比较大小的话，平方范数就可以了，所以这里并没有开平方根

:::

# References

1. 张弛. 基于卷积神经网络的鞋印图像分类算法研究
